<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flag Guessing Game</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding-right: 2rem; }
    img { width: min(50vw, 500px); height: auto; border: 1px solid #ccc; margin: auto;}
    input { padding: .5rem; font-size: 1rem; }
    button { padding: .5rem 1rem; margin-left: .5rem; margin-top: 10px;}
    p { font-weight: bold; margin-top: 1rem; color: inherit; font-size: 30px;}
    /* New styling for flag-given inputs: stack vertically full width */
    #flag-given-inputs input {
      display: block;
      width: min(50vw, 500px);
      margin-right: auto;
      margin-left: auto;
      margin-top: 10px;
      box-sizing: border-box;
    }
    /* The styling below is for the flag options container 
       and its flag images to maintain layout and size */
    #flag-options {
      width: 100vw;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      justify-content: center;
    }
    #flag-options img {
      width: auto;
      height: 10vw;
    }
  </style>
</head>
<body>
  <h1>Guess the Country</h1>

  <!-- New game selection section -->
  <div id="game-selection">
    <p>Select a game:</p>
    <button id="game-flag">Flag Given</button>
    <button id="game-country">Country Name Given</button>
    <button id="game-capital">Capital Given</button>
  </div>

  <!-- Game container (initially hidden) -->
  <div id="game-container" style="display:none;">
    <p id="question"></p>
    <img id="flag" src="" alt="Country Flag" style="display:none;">
    <div id="input-fields">
      <!-- For Flag Given: two inputs -->
      <div id="flag-given-inputs" style="display:none;">
        <input id="guess-country" placeholder="Guess Country Name…">
        <input id="guess-capital" placeholder="Guess Capital…">
      </div>
      <!-- For Country or Capital Given: one input -->
      <div id="single-input" style="display:none;">
        <input id="guess" placeholder="Your Answer…">
      </div>
    </div>
    <!-- Div for flag options (used when flag guess is required) -->
    <div id="flag-options" style="display:none; margin-top:1rem;"></div>
    <button id="submit">Submit</button>
  </div>

  
  <p id="feedback"></p>
  <p id="details" style="margin-top:0.5rem; color: #555; font-size: 20px;"></p>
  <button id="next-button" style="display: none;">Next Question</button>
  <script src="./countries.js"></script>
  <script>
    let current;
    let gameMode = ''; // "flagGiven", "countryNameGiven", "capitalGiven"

    function pickRandom() {
      document.getElementById('submit').disabled = false;
      document.getElementById('guess').disabled = false;
      document.getElementById('guess-country').disabled = false;
      document.getElementById('guess-capital').disabled = false;
      current = countries[Math.floor(Math.random() * countries.length)];
      if (gameMode === 'flagGiven') {
        document.getElementById('flag').src = current.flagUrl;
        document.getElementById('flag').style.display = 'block';
        document.getElementById('flag-given-inputs').style.display = 'block';
        document.getElementById('question').textContent = "Guess the Country and its capital based on the flag.";
        document.getElementById('flag-options').style.display = 'none';
      } else if (gameMode === 'countryNameGiven') {
        document.getElementById('question').textContent = `Country: ${current.names[0]}. Guess the capital.`;
        createFlagOptions();
      } else if (gameMode === 'capitalGiven') {
        document.getElementById('question').textContent = `Capital(s): ${current.capitals.join(", ")}. Guess the country.`;
        createFlagOptions();
      }
      document.getElementById('feedback').textContent = '';
      document.getElementById('guess').value = '';
      document.getElementById('guess-country') && (document.getElementById('guess-country').value = '');
      document.getElementById('guess-capital') && (document.getElementById('guess-capital').value = '');
      document.getElementById('details').textContent = '';
      // Hide the Next Question button when a new question starts
      document.getElementById('next-button').style.display = 'none';
      // Re-enable flag selection for new question
      document.getElementById('flag-options').style.pointerEvents = "auto";
      // focus the first visible input whenever a new question appears
      const firstInput = gameMode === 'flagGiven'
        ? document.getElementById('guess-country')
        : document.getElementById('guess');
      firstInput && firstInput.focus();
    }

    // createFlagOptions() builds flag options from three distractors plus the correct answer.
    function createFlagOptions() {
      const flagOptionsDiv = document.getElementById('flag-options');
      flagOptionsDiv.innerHTML = '';
      const distractors = [];
      while(distractors.length < 3) {
        const randomCountry = countries[Math.floor(Math.random() * countries.length)];
        if (randomCountry.flagUrl !== current.flagUrl && !distractors.includes(randomCountry)) {
          distractors.push(randomCountry);
        }
      }
      const options = distractors.concat(current);
      options.sort(() => Math.random() - 0.5);
      options.forEach(opt => {
        const img = document.createElement('img');
        img.src = opt.flagUrl;
        //img.style.width = "20vw";
        img.style.margin = "0 0.5rem";
        img.style.cursor = "pointer";
        // When a flag is clicked, reset unselected flags and highlight the selected one.
        img.addEventListener('click', () => {
            document.querySelectorAll('#flag-options img').forEach(el => {
                // Reset unselected flag borders to default style
                el.style.border = "1px solid #ccc";
                el.style.borderRadius = "";
                el.style.boxShadow = "";
            });
            // Highlight the selected flag
            img.style.border = "2px solid #005FCC";
            img.style.borderRadius = "4px";
            img.style.boxShadow = "0px 0px 10px 5px #5490ff";
            flagOptionsDiv.setAttribute('data-selected', opt.flagUrl);
        });
        flagOptionsDiv.appendChild(img);
      });
      flagOptionsDiv.style.display = 'block';
    }

    // 2. Levenshtein distance
    function levenshtein(a, b) {
      const m = a.length, n = b.length;
      const dp = Array.from({length: m+1}, () => Array(n+1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          dp[i][j] = Math.min(
            dp[i-1][j] + 1,
            dp[i][j-1] + 1,
            dp[i-1][j-1] + (a[i-1] === b[j-1] ? 0 : 1)
          );
        }
      }
      return dp[m][n];
    }

    // Game selection event listeners
    document.getElementById('game-flag').addEventListener('click', () => {
      gameMode = 'flagGiven';
      document.getElementById('game-selection').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';
      document.getElementById('flag').style.display = 'block';
      document.getElementById('flag-given-inputs').style.display = 'block';
      document.getElementById('single-input').style.display = 'none';
      document.getElementById('flag-options').style.display = 'none';
      document.getElementById('question').textContent = "Guess the Country and its Capital based on the flag.";
      pickRandom();
    });

    document.getElementById('game-country').addEventListener('click', () => {
      gameMode = 'countryNameGiven';
      document.getElementById('game-selection').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';
      document.getElementById('flag').style.display = 'none';
      document.getElementById('flag-given-inputs').style.display = 'none';
      document.getElementById('single-input').style.display = 'block';
      document.getElementById('guess').placeholder = "Guess the Capital";
      document.getElementById('question').textContent = ""; // will show country below
      pickRandom();
    });

    document.getElementById('game-capital').addEventListener('click', () => {
      gameMode = 'capitalGiven';
      document.getElementById('game-selection').style.display = 'none';
      document.getElementById('game-container').style.display = 'block';
      document.getElementById('flag').style.display = 'none';
      document.getElementById('flag-given-inputs').style.display = 'none';
      document.getElementById('single-input').style.display = 'block';
      document.getElementById('guess').placeholder = "Guess the Country";
      document.getElementById('question').textContent = ""; // will show capitals below
      pickRandom();
    });

    document.getElementById('submit').addEventListener('click', () => {
      // Disable submit button and answer inputs
      document.getElementById('submit').disabled = true;
      document.getElementById('guess').disabled = true;
      document.getElementById('guess-country').disabled = true;
      document.getElementById('guess-capital').disabled = true;
      
      let correct = false;
      let parts = [];
      
      if (gameMode === 'flagGiven') {
        const guessCountry = document.getElementById('guess-country').value.trim().toLowerCase();
        const guessCapital = document.getElementById('guess-capital').value.trim().toLowerCase();
        const countryCorrect = current.names.some(name => levenshtein(guessCountry, name.toLowerCase()) <= 2);
        const capitalCorrect = current.capitals.some(cap => levenshtein(guessCapital, cap.toLowerCase()) <= 2);
        correct = countryCorrect && capitalCorrect;
        parts = [
          countryCorrect ? '✔️ Country correct' : '❌ Country incorrect',
          capitalCorrect ? '✔️ Capital correct' : '❌ Capital incorrect'
        ];
      } else if (gameMode === 'countryNameGiven') {
        const guessCapital = document.getElementById('guess').value.trim().toLowerCase();
        const capitalCorrect = current.capitals.some(cap => levenshtein(guessCapital, cap.toLowerCase()) <= 2);
        const selectedFlag = document.getElementById('flag-options').getAttribute('data-selected');
        const flagCorrect = selectedFlag === current.flagUrl;
        correct = capitalCorrect && flagCorrect;
        parts = [
          capitalCorrect ? '✔️ Capital correct' : '❌ Capital incorrect',
          flagCorrect    ? '✔️ Flag correct'    : '❌ Flag incorrect'
        ];
        // highlight correct flag
        document.querySelectorAll('#flag-options img').forEach(img => {
          if (img.src === current.flagUrl) {
            img.style.border = "2px solid #00b831";
            img.style.borderRadius = "4px";
            img.style.boxShadow = "0px 0px 10px 5px #33ff40";
          }
        });
      } else if (gameMode === 'capitalGiven') {
        const guessCountry = document.getElementById('guess').value.trim().toLowerCase();
        const countryCorrect = current.names.some(name => levenshtein(guessCountry, name.toLowerCase()) <= 2);
        const selectedFlag = document.getElementById('flag-options').getAttribute('data-selected');
        const flagCorrect = selectedFlag === current.flagUrl;
        correct = countryCorrect && flagCorrect;
        parts = [
          countryCorrect ? '✔️ Country correct' : '❌ Country incorrect',
          flagCorrect    ? '✔️ Flag correct'    : '❌ Flag incorrect'
        ];
        // highlight correct flag
        document.querySelectorAll('#flag-options img').forEach(img => {
          if (img.src === current.flagUrl) {
            img.style.border = "2px solid #59ff60";
            img.style.borderRadius = "4px";
            img.style.boxShadow = "0px 0px 10px 5px #33ff40";
          }
        });
      }

      // common post‐submit rendering
      const feedbackEl = document.getElementById('feedback');
      feedbackEl.innerHTML = parts
        .map(text => `<span style="color:${text.startsWith('✔️')?'green':'red'}">${text}</span>`)
        .join(' ');
      feedbackEl.style.color = correct ? 'green' : 'red';
      document.getElementById('details').textContent = "Press Enter or click Next Question to continue.";
      document.getElementById('flag-options').style.pointerEvents = 'none';
      document.getElementById('next-button').style.display = 'inline-block';
    });
    
    // Global Enter listener with a 200ms debounce delay
    let enterTimeout;
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        clearTimeout(enterTimeout);
        enterTimeout = setTimeout(() => {
          if (!document.getElementById('submit').disabled) {
            // When submit is enabled, submit the guess.
            document.getElementById('submit').click();
          } else {
            // When submit is disabled, move on to the next question and re-enable inputs.
            pickRandom();
            document.getElementById('submit').disabled = false;
            document.getElementById('guess').disabled = false;
            document.getElementById('guess-country').disabled = false;
            document.getElementById('guess-capital').disabled = false;
          }
        }, 100);
      }
    });
    
    // Next Question button: triggers moving on to the next question when clicked.
    // No manual focus here; pickRandom() takes care of focusing.
    document.getElementById('next-button').addEventListener('click', () => {
      pickRandom();
    });
    
    // Initialize
    pickRandom();
  </script>
</body>
</html>